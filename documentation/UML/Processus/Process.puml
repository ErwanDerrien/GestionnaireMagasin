@startuml ProcessServicesSwitchCase

skinparam {
  BackgroundColor #F5F5F5
  ParticipantBackgroundColor #FFFFFF
  ArrowColor #1E90FF
}

start
:Recevoir requête HTTP;

partition KongGateway {
  :Vérifier API Key via header 'x-api-key';
  if (Clé valide ?) then (oui)
    :Extraire JWT si /login;
    :Router vers le bon service;
  else (non)
    :Retourner 401 Unauthorized;
    stop
  endif
}

partition AuthService {
  :Si route = /login;
  :Valider JWT ou credentials;
  if (Authentification réussie) then (oui)
    :Générer nouveau JWT;
    :Retourner 200 avec token;
  else (non)
    :Retourner 403 Forbidden;
  endif
}

partition ProductService {
  :Si route = /products/**;
  switch (Type de requête)
  case (GET /products)
    :Vérifier scope 'products:read';
    :Appeler get_products();
  case (POST /products/restock)
    :Vérifier scope 'products:write';
    :Appeler restock_products();
  case (autre)
    :Retourner 405 Not Allowed;
  endswitch
  :Retourner réponse;
}

partition OrderService {
  :Si route = /orders/**;
  switch (Type de requête)
  case (POST /orders)
    :Vérifier scope 'orders:create';
    :Valider payload;
    :Appeler create_order();
  case (GET /orders/report)
    :Vérifier scope 'orders:read';
    :Appeler generate_report();
  case (autre)
    :Retourner 405 Not Allowed;
  endswitch
  :Retourner réponse;
}

stop

@enduml