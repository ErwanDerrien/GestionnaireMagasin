@startuml UC1 et UC3 - Génération et visualistion de rapport

skinparam {
    BackgroundColor #F5F5F5
    ActorBorderColor #333
    ParticipantBackgroundColor #FFFFFF
    ParticipantBorderColor #666
    ArrowColor #1E90FF
    SequenceMessageAlign reverse
}

actor "Gestionnaire" as gestionnaire <<Person>>
participant "Dashboard Admin" as dashboard
participant "Kong Gateway" as kong
participant "OrderController" as order_controller
participant "OrderService" as service
database "PostgreSQL" as db
database "Redis" as cache

== Génération Rapport ==

gestionnaire -> dashboard : Générer rapport
activate dashboard
dashboard -> kong : GET /api/v2/orders/o/report
activate kong

kong -> kong : Vérifie API Key

alt API Key invalide
    kong -> dashboard : 401 Unauthorized
    deactivate kong
    dashboard -> gestionnaire : Erreur authentification
    deactivate dashboard
else API Key valide
    kong -> order_controller : GET /api/v2/orders/o/report
    activate order_controller
    order_controller -> cache : GET report:orders
    activate cache

    alt Données en cache
        cache -> order_controller : Hit (JSON)
        deactivate cache
        order_controller -> kong : 200 OK (cached)
    else
        cache -> order_controller : Miss
        deactivate cache
        order_controller -> service : generate_orders_report()
        activate service

        service -> db : SELECT ventes par magasin
        activate db
        db -> service : Données brutes
        deactivate db

        service -> db : SELECT top produits
        activate db
        db -> service : Top produits
        deactivate db

        service -> service : Formatage des données (ventes, produits, stock)
        service -> cache : SET report:orders (TTL=1h)
        activate cache
        cache -> service : OK
        deactivate cache

        service -> order_controller : Rapport formaté
        deactivate service
        order_controller -> kong : 200 OK
    end

    kong -> dashboard : Rapport JSON (ventes, produits, stock)
    deactivate kong
    dashboard -> gestionnaire : Affiche rapport
    deactivate dashboard
end